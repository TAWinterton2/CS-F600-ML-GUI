{% extends 'base.html' %}

{% block head %}
    <link rel="stylesheet" href="{{ url_for('static', filename='css/multi_form_style.css') }}">
    <title>Multi-Form Test</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/Chart.js/2.9.4/Chart.js"></script>

{% endblock %}

{% block body %}
    <div class="main">
        <div class="steps">
            <div id="regForm" action="">
                <div style="text-align:left; margin-top:20px;">
                    <span class="step"></span>
                    <span class="step"></span>
                    <span class="step"></span>
                    <span class="step"></span>
                </div>

                <h1 class="ML">Linear Regression</h1>
                
                <!-- Div for Uploading Dataset-->
                <div class="tab" id="step_1"><h2>Step 1: Uploading Dataset</h2>
                    <p>We would put instructions here to describe what type of dataset to use and what file type is accepted.</p>
                    <p>Below is a link that downloads a dummy CSV file that the user can use for testing</p>
                    <p><a href="https://cdn.wsform.com/wp-content/uploads/2020/06/probability.csv">https://cdn.wsform.com/wp-content/uploads/2020/06/probability.csv.</a></p>
                    <p>Otherwise, the user can upload a .csv/.zip file.</p>

                        {% if file_upload == True %}
                        <form id="columns" method="POST">
                            <p style="color:blue">File uploaded: {{filename}}.</p>
                            <p>Please select which columns you would like to test over.</p>
                            <p>Select X value</p>
                            <select type="X" name="X">
                                {% for c in column_names %}
                                <option value="{{c}}">{{c}}</option>
                                {% endfor %}
                            </select>
                            <p>Select Y value</p>
                            <select type="Y" name="Y">
                                {% for c in column_names %}
                                <option value="{{c}}">{{c}}</option>
                                {% endfor %}
                            </select>
                            <input type="submit" name="select_xy" value="Submit Column Selection">
                        </form>

                        {% else %}
                        <form id="upload" method="POST" enctype="multipart/form-data">
                            <input type="file" name="file">
                            <input type="submit" name="upload_file" value="Submit File">
                        </form>
                            <p style="color:crimson">{{error}}</p>
                        {% endif %}
                </div>

                <!-- Div for Scaling the Data Set-->
                <div class="tab" id="step_2"><h2>Step 2: Scaling the Dataset</h2>
                    <p>This section would explain what we mean by scaling the dataset, as well as what each option (if applicable)
                        means. The user will select an option (with standardize being the default) and then continue to the next step.
                    </p>
                    <form id="scale_type" method="POST">
                        <select name="scale" id="scale">
                            <option value="Standardize">Standardize</option>
                            <option value="Normalize">Normalize</option>
                        </select>
                        <input type="submit" name="scaling" value="Scaling Selected">
                    </form>
                </div>

                <!-- Div for Setting Testing and Training Sets-->
                <div class="tab" id="step_3"><h2>Step 3: Training and Testing</h2>
                    <p>We would explain what the testing + training datasets mean, the ideal split for this.</p>
                    {% if traintest == True %}
                        <p>User inputs:</p>
                        <p>Training: {{tr}} </p>
                        <p>Testing: {{te}}</p>
                    {% else %}
                    <form id="trte" method="POST">
                        <p><label for="training">Training:</label>
                        <input type="text" id="training" name="training" placeholder="80" oninput="this.className = ''"></p>
                        <p><label for="training">Testing:</label>
                        <input type="text" id="testing" name="testing" placeholder="20" oninput="this.className = ''"></p>
                        <input type="submit" name="tt" value="Training/Testing">
                    </form>
                        <p style="color:red">{{ error }}</p>
                    {% endif %}
                </div>


                <!-- Div for Changing all Hyperparameters-->
                <!-- Sorry if this div becomes super long :( 
                                            -Travis         -->
                <div class="tab" id="step_4"><h2>Step 4: Initialize the Model</h2>
                    {% if hyper==True %}
                    <p>Hyperparameters successfully inputted. Please press the next button to run the model.</p>
                    {% else %}
                    <form id="init" method="POST">
                    <p>
                        List of all Hyperparameters associated with ML model are listed here 
                        <br>
                        <br>

                        Users can adjust any of these as they wish <br>
                        We will leave default values for all options and make a notice to the user that it is <br>
                        recommended that they do not mess with any of these values at first until they are <br>
                        comfortable with how the ML process works

                        <br>
                        <br>
                        each of these parameters will also be accompanied by a description of what they do.
                        <br>  
                        <br>
                        <br>


                    </p>

                    <p>
                        <!-- 
                            Parameter: Loss Strength:

                            Dependent: No

                            The loss function to be used. 
                            The possible values are ‘squared_error’, ‘huber’, ‘epsilon_insensitive’, or ‘squared_epsilon_insensitive’

                            The ‘squared_error’ refers to the ordinary least squares fit. 
                            ‘huber’ modifies ‘squared_error’ to focus less on getting outliers correct by switching from squared to linear loss past a distance of epsilon. 
                            ‘epsilon_insensitive’ ignores errors less than epsilon and is linear past that; this is the loss function used in SVR. 
                            ‘squared_epsilon_insensitive’ is the same but becomes squared loss past a tolerance of epsilon.
                        -->
                        Loss Strength:
                        <select name = "loss Strength" id="Hyperparameters">
                            <option value="square_error">Squared Error</option>
                            <option value="epsilon_insensitive">Epsilon Insensitive</option>
                            <option value="squared_epsilon_insensitive">Squared Epsilon Insensitive</option>
                        </select>

                        &ensp;
                        
                        <!--
                            Parameter Penalty:

                            Dependent: No

                            The penalty (aka regularization term) to be used. Defaults to ‘l2’ which is the standard regularizer for linear SVM models. 
                            ‘l1’ and ‘elasticnet’ might bring sparsity to the model (feature selection) not achievable with ‘l2’. 

                            No penalty is added when set to None.
                        -->
                        Penalty:
                        <select name="penalty" id="Hyperparameters">
                            <option value="l2">l2</option>
                            <option value="l1">l1</option>
                            <option value="elasticent">Elasticent</option>
                            <option value="none">None</option>
                        </select>

                    </p>

                    <p>
                        <!--
                            Parameter: Alpha

                            Dependent: No

                            Constant that multiplies the regularization term. 
                            The higher the value, the stronger the regularization. 
                            Also used to compute the learning rate when set to learning_rate is set to ‘optimal’.

                        -->
                        <label for="alpha">Alpha:</label>
                        <input type="text" id="Hyperparameters" name="alpha" placeholder="0.0001" oninput="this.className = ' '">
                       
                        <!--
                            Parameter l1_ratio:

                            Dependent: "Penalty"

                            The Elastic Net mixing parameter, with 0 <= l1_ratio <= 1. 
                            l1_ratio=0 corresponds to L2 penalty, l1_ratio=1 to L1. 
                            Only used if penalty is ‘elasticnet’.
                        -->
                        <label for="l1_ratio">l1 Ratio:</label>
                        <input type="text" id="Hyperparameters" name="l1_ratio" placeholder="0.15" oninput="this.className =''">
    
                    </p>

                    <p>
                        <!--
                            Parameter: Fit Intercept:

                            Dependent: No

                            Whether the intercept should be estimated or not. If False, the data is assumed to be already centered.
                        -->
                        Fit Intercept:
                        <input type="radio" id="Hyperparameters" name="fit_int_true" value="fit_int_true" checked>
                        <label for="true">True</label>
                        <input type="radio" id="Hyperparameters" name="fit_int_false" value="fit_int_false">
                        <label for="false">False</label><br>
                    </p>

                    <p>
                        <!--
                            Parameter: Max Iteration:
                            
                            Dependent: No

                            The maximum number of passes over the training data (aka epochs). 
                            It only impacts the behavior in the fit method, and not the partial_fit method.
                        -->
                        <label for="max_iter">Max Iteration:</label>   
                        <input type="text" id="Hyperparameters" name="max_iter" placeholder="1000" oninput="this.className = ''">   
                    </p>

                    <p>
                        <!-- 
                            Parameter: Shuffle

                            Dependent: No

                            Whether or not the training data should be shuffled after each epoch.
                        -->
                        Shuffle:
                        <input type="radio" id="Hyperparameters" name="shuffle_true" value="true" checked>
                        <label for="true">True</label>
                        <input type="radio" id="Hyperparameters" name="shuffle_false" value="false">
                        <label for="false">False</label>
                    </p>



                    <p>
                        <!--
                            Parameter: Verbose

                            Dependent: No

                            The verbosity level.
                        -->
                        <label for="verbose">Verbose:</label>
                        <input type="text" id="Hyperparameters" name="verbose" placeholder="0" oninput="this.className=''">
                    </p>

                    <p>
                        <!--
                            Parameter: Epsilon

                            Dependent: "Loss"

                            Epsilon in the epsilon-insensitive loss functions; only if loss is ‘huber’, ‘epsilon_insensitive’, or ‘squared_epsilon_insensitive’. 
                            For ‘huber’, determines the threshold at which it becomes less important to get the prediction exactly right. 
                            For epsilon-insensitive, any differences between the current prediction and the correct label are ignored if they are less than this threshold.
                        -->
                        <label for="epsilon">Epsilon</label>
                        <input type="text" id="Hyperparameters" name="epsilon" placeholder="0.1" oninput="this.className=''">
                    </p>

                    <p>
                        <!--
                            Parameter: Randome State

                            Dependent: "Shuffle == True"

                            Used for shuffling the data, when shuffle is set to True. 
                            Pass an int for reproducible output across multiple function calls.
                        -->
                        <label for="rand_state">Random State</label>
                        <input type="text" id="Hyperparameters" name="rand_state" placeholder="0" oninput="this.className=''">

                    </p>

                    <p>
                        <!--
                            Parameter: Learning Rate:

                            Dependent: None

                            The learning rate schedule:

                                ‘constant’: eta = eta0

                                ‘optimal’: eta = 1.0 / (alpha * (t + t0)) where t0 is chosen by a heuristic proposed by Leon Bottou.

                                ‘invscaling’: eta = eta0 / pow(t, power_t)

                                ‘adaptive’: eta = eta0, as long as the training keeps decreasing. 
                                Each time n_iter_no_change consecutive epochs fail to decrease the training loss by 
                                tol or fail to increase validation score by tol if early_stopping is True, the current learning rate is divided by 5.
                        -->
                        Learning Rate:
                        <select name="learning_rate" id="Hyperparameters">
                            <option value="invscaling">Invscaling</option>
                            <option value="constant">Constant</option>
                            <option value="optimal">Optimal</option>
                            <option value="adaptive">Adaptive</option>
                        </select>
                    </p>

                    <p>
                        <!--
                            Parameter: eta0

                            Dependent: None

                            The initial learning rate for the ‘constant’, ‘invscaling’ or ‘adaptive’ schedules. The default value is 0.01.
                        -->
                        <label for="eta0">eta0</label>
                        <input type="text" id="Hyperparameters" name="epsilon" placeholder="0.01" oninput="this.className=''">

                    </p>

                    <p>
                        <!--
                            Parameter: power_t

                            Dependent: None

                            The exponent for inverse scaling learning rate.
                        -->
                        <label for="power_t">Power_T</label>
                        <input type="text" id="Hyperparameters" name="power_t" placeholder="0.25" oninput="this.className=''">

                    </p>

                    <p>
                        <!--
                            Parameter: Early Stopping

                            Depedent: None

                            Whether to use early stopping to terminate training when validation score is not improving. 
                            If set to True, it will automatically set aside a fraction of training data as validation and 
                            terminate training when validation score returned by the score method is not improving by at least tol for n_iter_no_change consecutive epochs.
                        -->
                        Early Stopping:
                        <input type="radio" id="Hyperparameters" name="Erl_stop_true" value="true">
                        <label for="true">True</label>
                        <input type="radio" id="Hyperparameters" name="Erl_stop_false" value="false" checked>
                        <label for="false">False</label>
                    </p>
                    
                    <p>
                        <!--
                            Parameter: Validation_fraction

                            Dependent: "Early Stopping == True"

                            The proportion of training data to set aside as validation set for early stopping. 
                            Must be between 0 and 1. Only used if early_stopping is True.

                        -->
                        <label for="validation_fraction">Validation Fraction</label>
                        <input type="text" id="Hyperparameters" name="validation_fraction" placeholder="0.1" oninput="this.className=''">
                    </p>

                    <p>
                        <!--
                            Parameter: tol

                            Dependent: Minor "Early Stopping" || "n_iter_no_change"

                            The stopping criterion. If it is not None, training will stop when (loss > best_loss - tol) for n_iter_no_change consecutive epochs. 
                            Convergence is checked against the training loss or the validation loss depending on the early_stopping parameter.


                        -->

                        <label for ="tol">Tol</label>
                        <input type="text" id="Hyperparameters" name="tol" placeholder="0.001" oninput="this.className=''">
                    </p>

                    <p>
                        <!--
                            Parameter: n_iter_no_change

                            Dependent: Minor "Early Stopping"

                            Number of iterations with no improvement to wait before stopping fitting. 
                            Convergence is checked against the training loss or the validation loss depending on the early_stopping parameter.


                        -->
                        <label for="n_iter_no_change"> # of Iterations (no change) </label>
                        <input type="text" id="Hyperparameters" name="n_iter_no_change" placeholder="5" oninput="this.className=''">

                    </p>

                    <p>
                        <!--
                            Parameter: Warm Start

                            Dependent: None

                            When set to True, reuse the solution of the previous call to fit as initialization, otherwise, just erase the previous solution.

                            Repeatedly calling fit or partial_fit when warm_start is True can result in a different solution than when calling fit a 
                            single time because of the way the data is shuffled. 

                            If a dynamic learning rate is used, the learning rate is adapted depending on the number of samples already seen. 
                            Calling fit resets this counter, while partial_fit will result in increasing the existing counter.
                        -->
                        Warm Start:
                        <input type="radio" id="Hyperparameters" name="warm_start_true" value="true">
                        <label for="true">True</label>
                        <input type="radio" id="Hyperparameters" name="warm_start_false" value="false" checked>
                        <label for="false">false</label>
                    </p>

                    <p>
                        <!--
                            Parameter: Average

                            Dependent: None

                            When set to True, computes the averaged SGD weights across all updates and stores the result in the coef_ attribute. 
                            If set to an int greater than 1, averaging will begin once the total number of samples seen reaches average. 

                            So average=10 will begin averaging after seeing 10 samples.
                        -->
                        Average:
                        <input type="radio" id="Hyperparameters" name="average_true" value="true">
                        <label for="true">True</label>
                        <input type="radio" id="Hyperparameters" name="average_false" value="false" checked>
                        <label for="false">false</label>
                    </p>


                    
                    <input type="submit" name="hyperparams" value="Hyperparams">
                </form>
                {% endif %}

               
                </div>


                
                <!-- Div for Running the Model-->
                <div class="tab" id="step_5"><h2>Step 5: Run</h2>
                    <form id="run" method="POST">
                    <p>If possible, we would review all the settings the user has inputted so the user 
                        can view everything before running. When the user presses the run button, the model
                        will run with the provided settings and either output an error message OR proceed to evaluation.</p>
                    <input type="submit" name="run" value="Run the model">
                </form>

                </div>
                <p>Once you are done with the above step and have submitted, click on the next button.</p>
                <!-- Next and Previous Buttons for Multi-page form-->
                <div style="overflow:auto;">
                    <div style="float:right;">
                    <button type="button" id="prevStp" onclick="nextPrev(-1)">Previous</button>
                    <button type="button" id="nextStp" onclick="nextPrev(1)">Next</button>
                    </div>
                </div>

            </div>
            <script type="text/javascript" id="js_tabs" tab_num = {{tab}} src="{{url_for('static', filename='ml_form_script.js')}}"></script>
        </div>

        <!-- Div for Output Display on Right Hand Side of Webpage-->
        <div class="display">
            <div class="output">
                <h1>Output</h1>
                {% if user_input == False %}
                    <p>Here will be any visualizations from the program.</p>
                {% else %}
                <form>
                    <input type="button" value="View Original Data" id="orig" og_df = '{{og_df}}' onclick="openWin()">
                </form>
                {% endif %}

                <!--If the flask server returns that a file has been uploaded, display a dummy graph.-->
                {% if columns_selected == True %}
                <h2>Original Dataset</h2>
                    <canvas id="myChart" style="width:80%; background-color: antiquewhite; align-content: center;"></canvas>
                    <script type="text/javascript" id="graph" name = "{{name}}" data = '{{data}}' columns = '{{column_names}}' src="{{url_for('static', filename='graph.js')}}"></script>
                {% endif %}

                <!--If the flask server returns that scaling has finished, display a table full of dummy data.-->
                {% if scaling==True %}
                <h2>"Scaled" Data</h2>
                    {% for table in tables %}
                        <table>
                            <thead>
                                <tr>
                                    {% for title in titles %}
                                        <th>{{ title }}</th>
                                    {% endfor %}
                                </tr>
                            </thead>
                            <tbody>
                                {{ table|safe }}
                            </tbody>
                        </table>
                    {% endfor %}
                {% endif %}

                <!--If the flask server returns that training/testing has finished, display 2 dummy graphs.-->
                {% if traintest==True %}
                <h2>"Testing" Dataset</h2>
                    <canvas id="testing" style="width:100%;max-width:300px;background-color: antiquewhite;align-content: center;"></canvas>
                    <script>
                        const test = [{x:.70, y:.8},{x:.90, y:.9},{x:.110, y:.10},{x:.140, y:.14}];

                    new Chart("testing", {
                    type: "scatter",
                    data: {
                        datasets: [{
                        pointRadius: 4,
                        pointBackgroundColor: "rgb(0,0,255)",
                        data: test
                        }]
                    },
                    options: {
                        legend: {display: false},
                        scales: {
                        xAxes: [{ticks: {min: 0.1, max:1.0}}],
                        yAxes: [{ticks: {min: 0.1, max:1.0}}],
                        }
                    }
                    });
                    </script>

                    <h2>"Training" Dataset</h2>
                    <canvas id="training" style="width:100%;max-width:300px;background-color: antiquewhite;align-content: center;"></canvas>
                    <script>
                        const train = [{x:.50, y:.7},{x:.60, y:.8},{x:.80, y:.9},{x:.100, y:.9},
                        {x:.110, y:.10},{x:.120, y:.11},{x:.130, y:.14},{x:.150, y:.15}];

                    new Chart("training", {
                    type: "scatter",
                    data: {
                        datasets: [{
                        pointRadius: 4,
                        pointBackgroundColor: "rgb(0,0,255)",
                        data: train
                        }]
                    },
                    options: {
                        legend: {display: false},
                        scales: {
                        xAxes: [{ticks: {min: 0.1, max:1.0}}],
                        yAxes: [{ticks: {min: 0.1, max:1.0}}],
                        }
                    }
                    });
                    </script>
                {% endif %}
                {% if start==True %}
                <p>Mean Absolute Error: .943124</p>
                <p>Mean Squared Error: .9653214 </p>
                <p>Root Mean Squared Error: .977777</p>
                <canvas id="eval" style="width:100%;max-width:300px;background-color: antiquewhite;align-content: center;"></canvas>
                    <script>
                        const error = [{x:50, y:7},{x:60, y:8},{x:70, y:8},{x:80, y:9},{x:90, y:9},{x:100, y:9},{x:110, y:10},
                        {x:120, y:11},{x:130, y:14},{x:140, y:14},{x:150, y:15}
                    ];

                    new Chart("eval", {
                    type: "scatter",
                    data: {
                        datasets: [{
                        pointRadius: 4,
                        pointBackgroundColor: "rgb(0,0,255)",
                        data: error
                        }]
                    },
                    options: {
                        legend: {display: false},
                        scales: {
                        xAxes: [{ticks: {min: 40, max:160}}],
                        yAxes: [{ticks: {min: 4, max:16}}],
                        }
                    }
                    });
                    </script>
                    
                {% endif %}
            </div>
           
        </div>
        
    </div>
{% endblock %}
